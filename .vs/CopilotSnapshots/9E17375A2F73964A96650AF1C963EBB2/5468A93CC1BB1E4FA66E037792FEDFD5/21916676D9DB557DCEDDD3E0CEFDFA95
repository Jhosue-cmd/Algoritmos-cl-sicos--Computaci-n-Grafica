using System;
using System.Drawing;
using System.Windows.Forms;

namespace Algoritmo_de_lineas
{
    public partial class frmDDA : Form
    {
        private CDDA algoritmo;
        private Bitmap bmp;
        private Graphics g;

        public frmDDA()
        {
            InitializeComponent();
            algoritmo = new CDDA();
        }

        private void frmDDA_Load(object sender, EventArgs e)
        {
            // Inicializar el bitmap y graphics para el PictureBox
            InicializarLienzo();
        }

        private void InicializarLienzo()
        {
            bmp = new Bitmap(pictureBox1.Width, pictureBox1.Height);
            g = Graphics.FromImage(bmp);
            g.Clear(Color.White);
            
            // Dibujar ejes de coordenadas
            DibujarEjes();
            
            pictureBox1.Image = bmp;
        }

        private void DibujarEjes()
        {
            using (Pen penEje = new Pen(Color.LightGray, 1))
            {
                // Eje X
                g.DrawLine(penEje, 0, pictureBox1.Height / 2, pictureBox1.Width, pictureBox1.Height / 2);
                // Eje Y
                g.DrawLine(penEje, pictureBox1.Width / 2, 0, pictureBox1.Width / 2, pictureBox1.Height);
            }
        }

        private void btnDibujar_Click(object sender, EventArgs e)
        {
            try
            {
                // Validar que todos los campos estén llenos
                if (string.IsNullOrWhiteSpace(txtX1.Text) || 
                    string.IsNullOrWhiteSpace(txtY1.Text) ||
                    string.IsNullOrWhiteSpace(txtX2.Text) || 
                    string.IsNullOrWhiteSpace(txtY2.Text))
                {
                    MessageBox.Show("Por favor, ingrese todos los valores de los puntos.", 
                        "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Validar que sean números enteros
                if (!int.TryParse(txtX1.Text, out int x1) || 
                    !int.TryParse(txtY1.Text, out int y1) ||
                    !int.TryParse(txtX2.Text, out int x2) || 
                    !int.TryParse(txtY2.Text, out int y2))
                {
                    MessageBox.Show("Por favor, ingrese solo números enteros.", 
                        "Datos inválidos", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // Validar que sean números positivos
                if (x1 < 0 || y1 < 0 || x2 < 0 || y2 < 0)
                {
                    MessageBox.Show("Por favor, ingrese solo números enteros positivos.", 
                        "Valores negativos", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // Validar que los puntos no sean iguales
                if (x1 == x2 && y1 == y2)
                {
                    MessageBox.Show("Los puntos inicial y final no pueden ser iguales.", 
                        "Puntos iguales", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Validar que la pendiente no sea cero (línea no horizontal)
                if (!algoritmo.ValidarPendiente(x1, y1, x2, y2))
                {
                    MessageBox.Show("La pendiente no puede ser cero.\nLa línea no puede ser horizontal (Y1 debe ser diferente de Y2).", 
                        "Pendiente inválida", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // Limpiar el lienzo
                g.Clear(Color.White);
                DibujarEjes();

                // Convertir coordenadas a sistema de coordenadas del PictureBox
                // (centrar en el origen)
                int centroX = pictureBox1.Width / 2;
                int centroY = pictureBox1.Height / 2;

                int px1 = centroX + x1;
                int py1 = centroY - y1;
                int px2 = centroX + x2;
                int py2 = centroY - y2;

                // Validar que los puntos estén dentro del área visible
                if (!ValidarPuntoEnArea(px1, py1) || !ValidarPuntoEnArea(px2, py2))
                {
                    MessageBox.Show("Los puntos están fuera del área visible.\nPor favor, use valores más pequeños.", 
                        "Fuera de rango", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Dibujar la línea usando el algoritmo DDA
                algoritmo.DibujarLinea(g, px1, py1, px2, py2, Color.Blue, 2);

                // Calcular y mostrar información de la pendiente
                double pendiente = algoritmo.CalcularPendiente(x1, y1, x2, y2);
                string infoPendiente = double.IsPositiveInfinity(pendiente) 
                    ? "∞ (línea vertical)" 
                    : pendiente.ToString("F2");

                MessageBox.Show($"Línea dibujada correctamente.\n\n" +
                              $"Punto inicial: ({x1}, {y1})\n" +
                              $"Punto final: ({x2}, {y2})\n" +
                              $"Pendiente: {infoPendiente}", 
                              "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);

                pictureBox1.Refresh();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al dibujar la línea: {ex.Message}", 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private bool ValidarPuntoEnArea(int x, int y)
        {
            return x >= 0 && x < pictureBox1.Width && y >= 0 && y < pictureBox1.Height;
        }

        private void btnBorrar_Click(object sender, EventArgs e)
        {
            // Limpiar todos los TextBox
            txtX1.Clear();
            txtY1.Clear();
            txtX2.Clear();
            txtY2.Clear();

            // Limpiar el lienzo
            g.Clear(Color.White);
            DibujarEjes();
            pictureBox1.Refresh();

            // Enfocar el primer TextBox
            txtX1.Focus();
        }

        private void groupBox2_Enter(object sender, EventArgs e)
        {
            // Evento no utilizado
        }

        private void label3_Click(object sender, EventArgs e)
        {
            // Evento no utilizado
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            // Liberar recursos
            if (g != null)
            {
                g.Dispose();
            }
            if (bmp != null)
            {
                bmp.Dispose();
            }
            base.OnFormClosing(e);
        }
    }
}
